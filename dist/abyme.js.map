{"version":3,"file":"abyme.js","sources":["../src/abyme_controller.js"],"sourcesContent":["import { Controller } from 'stimulus';\n\nexport default class extends Controller {\n  // static targets = ['template', 'associations', 'fields', 'newFields'];\n  // Some applications don't compile correctly with the usual static syntax. \n  // Thus implementing targets with standard getters below\n\n  static targets = ['template', 'associations', 'fields', 'newFields']\n\n  connect() {\n    console.log(\"Abyme Connected\")\n\n    if (this.count) {\n      // If data-count is present,\n      // add n default fields on page load\n\n      this.add_default_associations();\n    }\n  }\n\n  // return the value of the data-count attribute\n\n  get count() {\n    return this.element.dataset.minCount || 0;\n  }\n  \n  // return the value of the data-position attribute\n  // if there is no position specified set end as default\n\n  get position() {\n    return this.associationsTarget.dataset.abymePosition === 'end' ? 'beforeend' : 'afterbegin';\n  }\n\n  // ADD_ASSOCIATION\n\n  // this function is call whenever a click occurs\n  // on the element with the click->abyme#add_association\n  // <button> element by default\n\n  // if a data-count is present the add_association\n  // will be call without an event so we have to check\n  // this case\n\n  // check for limit reached \n  // dispatch an event if the limit is reached\n\n  // - call the function build_html that take care\n  //   for building the correct html to be inserted in the DOM\n  // - dispatch an event before insert\n  // - insert html into the dom\n  // - dispatch an event after insert\n\n  add_association(event) {\n    if (event) {\n      event.preventDefault();\n    }\n\n    if (this.element.dataset.limit && this.limit_check()) {\n      this.create_event('limit-reached')\n      return false\n    }\n\n    const html = this.build_html();\n    this.create_event('before-add');\n    this.associationsTarget.insertAdjacentHTML(this.position, html);\n    this.create_event('after-add');\n  }\n\n  // REMOVE_ASSOCIATION\n\n  // this function is call whenever a click occurs\n  // on the element with the click->abyme#remove_association\n  // <button> element by default\n\n  // - call the function mark_for_destroy that takes care\n  //   of marking the element for destruction and hiding it\n  // - dispatch an event before mark & hide\n  // - mark for descrution + hide the element\n  // - dispatch an event after mark and hide\n\n  remove_association(event) {\n    event.preventDefault();\n\n    this.create_event('before-remove');\n    this.mark_for_destroy(event);\n    this.create_event('after-remove');\n  }\n\n  // LIFECYCLE EVENTS RELATED\n\n  // CREATE_EVENT\n\n  // take a stage (String) => before-add, after-add...\n  // create a new custom event \n  // and dispatch at at the controller level\n\n  create_event(stage, html = null) {\n    const event = new CustomEvent(`abyme:${stage}`, { detail: {controller: this, content: html} });\n    this.element.dispatchEvent(event);\n    // WIP\n    this.dispatch(event, stage);\n  }\n\n  // WIP : Trying to integrate event handling through controller inheritance\n  dispatch(event, stage) {\n    if (stage === 'before-add' && this.abymeBeforeAdd) this.abymeBeforeAdd(event);\n    if (stage === 'after-add' && this.abymeAfterAdd) this.abymeAfterAdd(event);\n    if (stage === 'before-remove' && this.abymeBeforeRemove) this.abymeBeforeAdd(event);\n    if (stage === 'after-remove' && this.abymeAfterRemove) this.abymeAfterRemove(event);\n  }\n\n  abymeBeforeAdd(event) {\n  }\n\n  abymeAfterAdd(event) {\n  }\n\n  abymeBeforeRemove(event) {\n  }\n\n  abymeAfterRemove(event) {\n  }\n\n  // BUILD HTML\n\n  // takes the html template and substitutes the sub-string\n  // NEW_RECORD for a generated timestamp\n  // then if there is a sub template in the html (multiple nested level)\n  // set all the sub timestamps back as NEW_RECORD\n  // finally returns the html  \n\n  build_html() {\n    let html = this.templateTarget.innerHTML.replace(\n      /NEW_RECORD/g,\n      new Date().getTime()\n    );\n      \n    if (html.match(/<template[\\s\\S]+<\\/template>/)) {\n      const template = html\n      .match(/<template[\\s\\S]+<\\/template>/)[0]\n      .replace(/(\\[\\d{12,}\\])(\\[[^\\[\\]]+\\]\"){1}/g, `[NEW_RECORD]$2`);\n      \n      html = html.replace(/<template[\\s\\S]+<\\/template>/g, template);\n    }\n\n    return html;\n  }\n  \n  // MARK_FOR_DESTROY\n\n  // mark association for destruction\n  // get the closest abyme--fields from the remove_association button\n  // set the _destroy input value as 1\n  // hide the element\n  // add the class of abyme--marked-for-destroy to the element\n\n  mark_for_destroy(event) {\n    let item = event.target.closest('.abyme--fields');\n    item.querySelector(\"input[name*='_destroy']\").value = 1;\n    item.style.display = 'none';\n    item.classList.add('abyme--marked-for-destroy')\n  }\n\n\n  // LIMIT_CHECK\n\n  // Check if associations limit is reached\n  // based on newFieldsTargets only\n  // persisted fields are ignored\n\n  limit_check() {\n    return (this.newFieldsTargets\n                .filter(item => !item.classList.contains('abyme--marked-for-destroy'))).length \n                >= parseInt(this.element.dataset.limit)\n  }\n\n  // ADD_DEFAULT_ASSOCIATION\n\n  // Add n default blank associations at page load\n  // call sleep function to ensure uniqueness of timestamp\n\n  async add_default_associations() {\n    let i = 0\n    while (i < this.count) {\n      this.add_association()\n      i++\n      await this.sleep(1);\n    }\n  }\n\n  sleep(ms) {\n    return new Promise(resolve => setTimeout(resolve, ms));\n  }\n}\n"],"names":["_settle","pact","state","value","s","_Pact","o","bind","v","then","observer","connect","console","log","this","count","add_default_associations","add_association","event","preventDefault","element","dataset","limit","limit_check","create_event","html","build_html","associationsTarget","insertAdjacentHTML","position","remove_association","mark_for_destroy","stage","CustomEvent","detail","controller","content","dispatchEvent","dispatch","abymeBeforeAdd","abymeAfterAdd","abymeBeforeRemove","abymeAfterRemove","templateTarget","innerHTML","replace","Date","getTime","match","template","item","target","closest","querySelector","style","display","classList","add","newFieldsTargets","filter","contains","length","parseInt","i","test","update","body","shouldContinue","_isSettledPact","result","reject","_resumeAfterTest","_resumeAfterBody","updateValue","_this2","sleep","ms","Promise","resolve","setTimeout","minCount","abymePosition","prototype","onFulfilled","onRejected","callback","e","_this","thenable","targets"],"mappings":"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"}