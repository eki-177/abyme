function t(e,r){return t=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},t(e,r)}function e(t){return t.replace(/(?:[_-])([a-z0-9])/g,(t,e)=>e.toUpperCase())}function r(t){return t.charAt(0).toUpperCase()+t.slice(1)}function n(t,e){const r=o(t);return Array.from(r.reduce((t,r)=>(function(t,e){const r=t[e];return Array.isArray(r)?r:[]}(r,e).forEach(e=>t.add(e)),t),new Set))}function o(t){const e=[];for(;t;)e.push(t),t=Object.getPrototypeOf(t);return e.reverse()}function i(t){return t.reduce((t,[e,r])=>Object.assign(Object.assign({},t),{[e]:r}),{})}function s([t,r],n){return function(t){const r=`${o=t.token,o.replace(/([A-Z])/g,(t,e)=>`-${e.toLowerCase()}`)}-value`,n=function(t){const e=function(t){const e=a(t.typeObject.type);if(!e)return;const r=c(t.typeObject.default);if(e!==r)throw new Error(`The specified default value for the Stimulus Value "${t.controller?`${t.controller}.${t.token}`:t.token}" must match the defined type "${e}". The provided default value of "${t.typeObject.default}" is of type "${r}".`);return e}({controller:t.controller,token:t.token,typeObject:t.typeDefinition}),r=c(t.typeDefinition),n=a(t.typeDefinition),o=e||r||n;if(o)return o;throw new Error(`Unknown value type "${t.controller?`${t.controller}.${t.typeDefinition}`:t.token}" for "${t.token}" value`)}(t);var o;return{type:n,key:r,name:e(r),get defaultValue(){return function(t){const e=a(t);if(e)return u[e];const r=t.default;return void 0!==r?r:t}(t.typeDefinition)},get hasCustomDefaultValue(){return void 0!==c(t.typeDefinition)},reader:l[n],writer:f[n]||f.default}}({controller:n,token:t,typeDefinition:r})}function a(t){switch(t){case Array:return"array";case Boolean:return"boolean";case Number:return"number";case Object:return"object";case String:return"string"}}function c(t){switch(typeof t){case"boolean":return"boolean";case"number":return"number";case"string":return"string"}return Array.isArray(t)?"array":"[object Object]"===Object.prototype.toString.call(t)?"object":void 0}(()=>{try{!function(){const t=function(t){function e(){return Reflect.construct(t,arguments,new.target)}return e.prototype=Object.create(t.prototype,{constructor:{value:e}}),Reflect.setPrototypeOf(e,t),e}(function(){this.a.call(this)});t.prototype.a=function(){},new t}()}catch(t){return t=>class extends t{}}})(),Object.assign(Object.assign({enter:"Enter",tab:"Tab",esc:"Escape",space:" ",up:"ArrowUp",down:"ArrowDown",left:"ArrowLeft",right:"ArrowRight",home:"Home",end:"End"},i("abcdefghijklmnopqrstuvwxyz".split("").map(t=>[t,t]))),i("0123456789".split("").map(t=>[t,t])));const u={get array(){return[]},boolean:!1,number:0,get object(){return{}},string:""},l={array(t){const e=JSON.parse(t);if(!Array.isArray(e))throw new TypeError(`expected value of type "array" but instead got value "${t}" of type "${c(e)}"`);return e},boolean:t=>!("0"==t||"false"==String(t).toLowerCase()),number:t=>Number(t),object(t){const e=JSON.parse(t);if(null===e||"object"!=typeof e||Array.isArray(e))throw new TypeError(`expected value of type "object" but instead got value "${t}" of type "${c(e)}"`);return e},string:t=>t},f={default:function(t){return`${t}`},array:d,object:d};function d(t){return JSON.stringify(t)}class h{constructor(t){this.context=t}static get shouldLoad(){return!0}static afterLoad(t,e){}get application(){return this.context.application}get scope(){return this.context.scope}get element(){return this.scope.element}get identifier(){return this.scope.identifier}get targets(){return this.scope.targets}get outlets(){return this.scope.outlets}get classes(){return this.scope.classes}get data(){return this.scope.data}initialize(){}connect(){}disconnect(){}dispatch(t,{target:e=this.element,detail:r={},prefix:n=this.identifier,bubbles:o=!0,cancelable:i=!0}={}){const s=new CustomEvent(n?`${n}:${t}`:t,{detail:r,bubbles:o,cancelable:i});return e.dispatchEvent(s),s}}function p(t,e,r){if(!t.s){if(r instanceof g){if(!r.s)return void(r.o=p.bind(null,t,e));1&e&&(e=r.s),r=r.v}if(r&&r.then)return void r.then(p.bind(null,t,e),p.bind(null,t,2));t.s=e,t.v=r;var n=t.o;n&&n(t)}}h.blessings=[function(t){return n(t,"classes").reduce((t,e)=>{return Object.assign(t,{[`${n=e}Class`]:{get(){const{classes:t}=this;if(t.has(n))return t.get(n);{const e=t.getAttributeName(n);throw new Error(`Missing attribute "${e}"`)}}},[`${n}Classes`]:{get(){return this.classes.getAll(n)}},[`has${r(n)}Class`]:{get(){return this.classes.has(n)}}});var n},{})},function(t){return n(t,"targets").reduce((t,e)=>{return Object.assign(t,{[`${n=e}Target`]:{get(){const t=this.targets.find(n);if(t)return t;throw new Error(`Missing target element "${n}" for "${this.identifier}" controller`)}},[`${n}Targets`]:{get(){return this.targets.findAll(n)}},[`has${r(n)}Target`]:{get(){return this.targets.has(n)}}});var n},{})},function(t){const e=function(t,e){return o(t).reduce((t,e)=>(t.push(...function(t,e){const r=t.values;return r?Object.keys(r).map(t=>[t,r[t]]):[]}(e)),t),[])}(t),n={valueDescriptorMap:{get(){return e.reduce((t,e)=>{const r=s(e,this.identifier),n=this.data.getAttributeNameForKey(r.key);return Object.assign(t,{[n]:r})},{})}}};return e.reduce((t,e)=>Object.assign(t,function(t,e){const n=s(t,void 0),{key:o,name:i,reader:a,writer:c}=n;return{[i]:{get(){const t=this.data.get(o);return null!==t?a(t):n.defaultValue},set(t){void 0===t?this.data.delete(o):this.data.set(o,c(t))}},[`has${r(i)}`]:{get(){return this.data.has(o)||n.hasCustomDefaultValue}}}}(e)),n)},function(t){return n(t,"outlets").reduce((t,n)=>Object.assign(t,function(t){const n=e(t.replace(/--/g,"-").replace(/__/g,"_"));return{[`${n}Outlet`]:{get(){const e=this.outlets.find(t);if(e){const r=this.application.getControllerForElementAndIdentifier(e,t);if(r)return r;throw new Error(`Missing "data-controller=${t}" attribute on outlet element for "${this.identifier}" controller`)}throw new Error(`Missing outlet element "${t}" for "${this.identifier}" controller`)}},[`${n}Outlets`]:{get(){const e=this.outlets.findAll(t);return e.length>0?e.map(e=>{const r=this.application.getControllerForElementAndIdentifier(e,t);if(r)return r;console.warn(`The provided outlet element is missing the outlet controller "${t}" for "${this.identifier}"`,e)}).filter(t=>t):[]}},[`${n}OutletElement`]:{get(){const e=this.outlets.find(t);if(e)return e;throw new Error(`Missing outlet element "${t}" for "${this.identifier}" controller`)}},[`${n}OutletElements`]:{get(){return this.outlets.findAll(t)}},[`has${r(n)}Outlet`]:{get(){return this.outlets.has(t)}}}}(n)),{})}],h.targets=[],h.outlets=[],h.values={};var m=/*#__PURE__*/function(e){var r,n;function o(){return e.apply(this,arguments)||this}n=e,(r=o).prototype=Object.create(n.prototype),r.prototype.constructor=r,t(r,n);var i,s,a=o.prototype;return a.connect=function(){console.log("Abyme Connected"),this.count&&this.add_default_associations()},a.add_association=function(t){if(t&&t.preventDefault(),this.element.dataset.limit&&this.limit_check())return this.create_event("limit-reached"),!1;var e=this.build_html();this.create_event("before-add"),this.associationsTarget.insertAdjacentHTML(this.position,e),this.create_event("after-add")},a.remove_association=function(t){t.preventDefault(),this.create_event("before-remove"),this.mark_for_destroy(t),this.create_event("after-remove")},a.create_event=function(t,e){void 0===e&&(e=null);var r=new CustomEvent("abyme:"+t,{detail:{controller:this,content:e}});this.element.dispatchEvent(r),this.dispatch(r,t)},a.dispatch=function(t,e){"before-add"===e&&this.abymeBeforeAdd&&this.abymeBeforeAdd(t),"after-add"===e&&this.abymeAfterAdd&&this.abymeAfterAdd(t),"before-remove"===e&&this.abymeBeforeRemove&&this.abymeBeforeAdd(t),"after-remove"===e&&this.abymeAfterRemove&&this.abymeAfterRemove(t)},a.abymeBeforeAdd=function(t){},a.abymeAfterAdd=function(t){},a.abymeBeforeRemove=function(t){},a.abymeAfterRemove=function(t){},a.build_html=function(){var t=this.templateTarget.innerHTML.replace(/NEW_RECORD/g,(new Date).getTime());if(t.match(/<template[\s\S]+<\/template>/)){var e=t.match(/<template[\s\S]+<\/template>/)[0].replace(/(\[\d{12,}\])(\[[^\[\]]+\]"){1}/g,"[NEW_RECORD]$2");t=t.replace(/<template[\s\S]+<\/template>/g,e)}return t},a.mark_for_destroy=function(t){var e=t.target.closest(".abyme--fields");e.querySelector("input[name*='_destroy']").value=1,e.style.display="none",e.classList.add("abyme--marked-for-destroy")},a.limit_check=function(){return this.newFieldsTargets.filter(function(t){return!t.classList.contains("abyme--marked-for-destroy")}).length>=parseInt(this.element.dataset.limit)},a.add_default_associations=function(){try{var t=this,e=0,r=function(t,e,r){for(var n;;){var o=t();if(b(o)&&(o=o.v),!o)return i;if(o.then){n=0;break}var i=r();if(i&&i.then){if(!b(i)){n=1;break}i=i.s}}var s=new g,a=p.bind(null,s,2);return(0===n?o.then(u):1===n?i.then(c):(void 0).then(function(){(o=t())?o.then?o.then(u).then(void 0,a):u(o):p(s,1,i)})).then(void 0,a),s;function c(e){i=e;do{if(!(o=t())||b(o)&&!o.v)return void p(s,1,i);if(o.then)return void o.then(u).then(void 0,a);b(i=r())&&(i=i.v)}while(!i||!i.then);i.then(c).then(void 0,a)}function u(t){t?(i=r())&&i.then?i.then(c).then(void 0,a):c(i):p(s,1,i)}}(function(){return e<t.count},0,function(){return t.add_association(),e++,Promise.resolve(t.sleep(1)).then(function(){})});return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},a.sleep=function(t){return new Promise(function(e){return setTimeout(e,t)})},i=o,(s=[{key:"count",get:function(){return this.element.dataset.minCount||0}},{key:"position",get:function(){return"end"===this.associationsTarget.dataset.abymePosition?"beforeend":"afterbegin"}}])&&function(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}(i.prototype,s),Object.defineProperty(i,"prototype",{writable:!1}),o}(h);const g=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(e,r){const n=new t,o=this.s;if(o){const t=1&o?e:r;if(t){try{p(n,1,t(this.v))}catch(t){p(n,2,t)}return n}return this}return this.o=function(t){try{const o=t.v;1&t.s?p(n,1,e?e(o):o):r?p(n,1,r(o)):p(n,2,o)}catch(t){p(n,2,t)}},n},t}();function b(t){return t instanceof g&&1&t.s}m.targets=["template","associations","fields","newFields"];export{m as AbymeController};
//# sourceMappingURL=abyme.module.js.map
