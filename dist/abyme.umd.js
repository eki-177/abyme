!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e||self).abyme={})}(this,function(e){function t(e,r){return t=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},t(e,r)}function r(e){return e.replace(/(?:[_-])([a-z0-9])/g,(e,t)=>t.toUpperCase())}function n(e){return e.charAt(0).toUpperCase()+e.slice(1)}function o(e,t){const r=i(e);return Array.from(r.reduce((e,r)=>(function(e,t){const r=e[t];return Array.isArray(r)?r:[]}(r,t).forEach(t=>e.add(t)),e),new Set))}function i(e){const t=[];for(;e;)t.push(e),e=Object.getPrototypeOf(e);return t.reverse()}function s(e){return e.reduce((e,[t,r])=>Object.assign(Object.assign({},e),{[t]:r}),{})}function a([e,t],n){return function(e){const t=`${o=e.token,o.replace(/([A-Z])/g,(e,t)=>`-${t.toLowerCase()}`)}-value`,n=function(e){const t=function(e){const t=c(e.typeObject.type);if(!t)return;const r=u(e.typeObject.default);if(t!==r)throw new Error(`The specified default value for the Stimulus Value "${e.controller?`${e.controller}.${e.token}`:e.token}" must match the defined type "${t}". The provided default value of "${e.typeObject.default}" is of type "${r}".`);return t}({controller:e.controller,token:e.token,typeObject:e.typeDefinition}),r=u(e.typeDefinition),n=c(e.typeDefinition),o=t||r||n;if(o)return o;throw new Error(`Unknown value type "${e.controller?`${e.controller}.${e.typeDefinition}`:e.token}" for "${e.token}" value`)}(e);var o;return{type:n,key:t,name:r(t),get defaultValue(){return function(e){const t=c(e);if(t)return l[t];const r=e.default;return void 0!==r?r:e}(e.typeDefinition)},get hasCustomDefaultValue(){return void 0!==u(e.typeDefinition)},reader:f[n],writer:d[n]||d.default}}({controller:n,token:e,typeDefinition:t})}function c(e){switch(e){case Array:return"array";case Boolean:return"boolean";case Number:return"number";case Object:return"object";case String:return"string"}}function u(e){switch(typeof e){case"boolean":return"boolean";case"number":return"number";case"string":return"string"}return Array.isArray(e)?"array":"[object Object]"===Object.prototype.toString.call(e)?"object":void 0}(()=>{try{!function(){const e=function(e){function t(){return Reflect.construct(e,arguments,new.target)}return t.prototype=Object.create(e.prototype,{constructor:{value:t}}),Reflect.setPrototypeOf(t,e),t}(function(){this.a.call(this)});e.prototype.a=function(){},new e}()}catch(e){return e=>class extends e{}}})(),Object.assign(Object.assign({enter:"Enter",tab:"Tab",esc:"Escape",space:" ",up:"ArrowUp",down:"ArrowDown",left:"ArrowLeft",right:"ArrowRight",home:"Home",end:"End"},s("abcdefghijklmnopqrstuvwxyz".split("").map(e=>[e,e]))),s("0123456789".split("").map(e=>[e,e])));const l={get array(){return[]},boolean:!1,number:0,get object(){return{}},string:""},f={array(e){const t=JSON.parse(e);if(!Array.isArray(t))throw new TypeError(`expected value of type "array" but instead got value "${e}" of type "${u(t)}"`);return t},boolean:e=>!("0"==e||"false"==String(e).toLowerCase()),number:e=>Number(e),object(e){const t=JSON.parse(e);if(null===t||"object"!=typeof t||Array.isArray(t))throw new TypeError(`expected value of type "object" but instead got value "${e}" of type "${u(t)}"`);return t},string:e=>e},d={default:function(e){return`${e}`},array:h,object:h};function h(e){return JSON.stringify(e)}class p{constructor(e){this.context=e}static get shouldLoad(){return!0}static afterLoad(e,t){}get application(){return this.context.application}get scope(){return this.context.scope}get element(){return this.scope.element}get identifier(){return this.scope.identifier}get targets(){return this.scope.targets}get outlets(){return this.scope.outlets}get classes(){return this.scope.classes}get data(){return this.scope.data}initialize(){}connect(){}disconnect(){}dispatch(e,{target:t=this.element,detail:r={},prefix:n=this.identifier,bubbles:o=!0,cancelable:i=!0}={}){const s=new CustomEvent(n?`${n}:${e}`:e,{detail:r,bubbles:o,cancelable:i});return t.dispatchEvent(s),s}}function m(e,t,r){if(!e.s){if(r instanceof y){if(!r.s)return void(r.o=m.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(m.bind(null,e,t),m.bind(null,e,2));e.s=t,e.v=r;var n=e.o;n&&n(e)}}p.blessings=[function(e){return o(e,"classes").reduce((e,t)=>{return Object.assign(e,{[`${r=t}Class`]:{get(){const{classes:e}=this;if(e.has(r))return e.get(r);{const t=e.getAttributeName(r);throw new Error(`Missing attribute "${t}"`)}}},[`${r}Classes`]:{get(){return this.classes.getAll(r)}},[`has${n(r)}Class`]:{get(){return this.classes.has(r)}}});var r},{})},function(e){return o(e,"targets").reduce((e,t)=>{return Object.assign(e,{[`${r=t}Target`]:{get(){const e=this.targets.find(r);if(e)return e;throw new Error(`Missing target element "${r}" for "${this.identifier}" controller`)}},[`${r}Targets`]:{get(){return this.targets.findAll(r)}},[`has${n(r)}Target`]:{get(){return this.targets.has(r)}}});var r},{})},function(e){const t=function(e,t){return i(e).reduce((e,t)=>(e.push(...function(e,t){const r=e.values;return r?Object.keys(r).map(e=>[e,r[e]]):[]}(t)),e),[])}(e),r={valueDescriptorMap:{get(){return t.reduce((e,t)=>{const r=a(t,this.identifier),n=this.data.getAttributeNameForKey(r.key);return Object.assign(e,{[n]:r})},{})}}};return t.reduce((e,t)=>Object.assign(e,function(e,t){const r=a(e,void 0),{key:o,name:i,reader:s,writer:c}=r;return{[i]:{get(){const e=this.data.get(o);return null!==e?s(e):r.defaultValue},set(e){void 0===e?this.data.delete(o):this.data.set(o,c(e))}},[`has${n(i)}`]:{get(){return this.data.has(o)||r.hasCustomDefaultValue}}}}(t)),r)},function(e){return o(e,"outlets").reduce((e,t)=>Object.assign(e,function(e){const t=r(e.replace(/--/g,"-").replace(/__/g,"_"));return{[`${t}Outlet`]:{get(){const t=this.outlets.find(e);if(t){const r=this.application.getControllerForElementAndIdentifier(t,e);if(r)return r;throw new Error(`Missing "data-controller=${e}" attribute on outlet element for "${this.identifier}" controller`)}throw new Error(`Missing outlet element "${e}" for "${this.identifier}" controller`)}},[`${t}Outlets`]:{get(){const t=this.outlets.findAll(e);return t.length>0?t.map(t=>{const r=this.application.getControllerForElementAndIdentifier(t,e);if(r)return r;console.warn(`The provided outlet element is missing the outlet controller "${e}" for "${this.identifier}"`,t)}).filter(e=>e):[]}},[`${t}OutletElement`]:{get(){const t=this.outlets.find(e);if(t)return t;throw new Error(`Missing outlet element "${e}" for "${this.identifier}" controller`)}},[`${t}OutletElements`]:{get(){return this.outlets.findAll(e)}},[`has${n(t)}Outlet`]:{get(){return this.outlets.has(e)}}}}(t)),{})}],p.targets=[],p.outlets=[],p.values={};var b=function(e){var r,n;function o(){return e.apply(this,arguments)||this}n=e,(r=o).prototype=Object.create(n.prototype),r.prototype.constructor=r,t(r,n);var i,s,a=o.prototype;return a.connect=function(){console.log("Abyme Connected"),this.count&&this.add_default_associations()},a.add_association=function(e){if(e&&e.preventDefault(),this.element.dataset.limit&&this.limit_check())return this.create_event("limit-reached"),!1;var t=this.build_html();this.create_event("before-add"),this.associationsTarget.insertAdjacentHTML(this.position,t),this.create_event("after-add")},a.remove_association=function(e){e.preventDefault(),this.create_event("before-remove"),this.mark_for_destroy(e),this.create_event("after-remove")},a.create_event=function(e,t){void 0===t&&(t=null);var r=new CustomEvent("abyme:"+e,{detail:{controller:this,content:t}});this.element.dispatchEvent(r),this.dispatch(r,e)},a.dispatch=function(e,t){"before-add"===t&&this.abymeBeforeAdd&&this.abymeBeforeAdd(e),"after-add"===t&&this.abymeAfterAdd&&this.abymeAfterAdd(e),"before-remove"===t&&this.abymeBeforeRemove&&this.abymeBeforeAdd(e),"after-remove"===t&&this.abymeAfterRemove&&this.abymeAfterRemove(e)},a.abymeBeforeAdd=function(e){},a.abymeAfterAdd=function(e){},a.abymeBeforeRemove=function(e){},a.abymeAfterRemove=function(e){},a.build_html=function(){var e=this.templateTarget.innerHTML.replace(/NEW_RECORD/g,(new Date).getTime());if(e.match(/<template[\s\S]+<\/template>/)){var t=e.match(/<template[\s\S]+<\/template>/)[0].replace(/(\[\d{12,}\])(\[[^\[\]]+\]"){1}/g,"[NEW_RECORD]$2");e=e.replace(/<template[\s\S]+<\/template>/g,t)}return e},a.mark_for_destroy=function(e){var t=e.target.closest(".abyme--fields");t.querySelector("input[name*='_destroy']").value=1,t.style.display="none",t.classList.add("abyme--marked-for-destroy")},a.limit_check=function(){return this.newFieldsTargets.filter(function(e){return!e.classList.contains("abyme--marked-for-destroy")}).length>=parseInt(this.element.dataset.limit)},a.add_default_associations=function(){try{var e=this,t=0,r=function(e,t,r){for(var n;;){var o=e();if(g(o)&&(o=o.v),!o)return i;if(o.then){n=0;break}var i=r();if(i&&i.then){if(!g(i)){n=1;break}i=i.s}}var s=new y,a=m.bind(null,s,2);return(0===n?o.then(u):1===n?i.then(c):(void 0).then(function(){(o=e())?o.then?o.then(u).then(void 0,a):u(o):m(s,1,i)})).then(void 0,a),s;function c(t){i=t;do{if(!(o=e())||g(o)&&!o.v)return void m(s,1,i);if(o.then)return void o.then(u).then(void 0,a);g(i=r())&&(i=i.v)}while(!i||!i.then);i.then(c).then(void 0,a)}function u(e){e?(i=r())&&i.then?i.then(c).then(void 0,a):c(i):m(s,1,i)}}(function(){return t<e.count},0,function(){return e.add_association(),t++,Promise.resolve(e.sleep(1)).then(function(){})});return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},a.sleep=function(e){return new Promise(function(t){return setTimeout(t,e)})},i=o,(s=[{key:"count",get:function(){return this.element.dataset.minCount||0}},{key:"position",get:function(){return"end"===this.associationsTarget.dataset.abymePosition?"beforeend":"afterbegin"}}])&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(i.prototype,s),Object.defineProperty(i,"prototype",{writable:!1}),o}(p),y=function(){function e(){}return e.prototype.then=function(t,r){var n=new e,o=this.s;if(o){var i=1&o?t:r;if(i){try{m(n,1,i(this.v))}catch(e){m(n,2,e)}return n}return this}return this.o=function(e){try{var o=e.v;1&e.s?m(n,1,t?t(o):o):r?m(n,1,r(o)):m(n,2,o)}catch(e){m(n,2,e)}},n},e}();function g(e){return e instanceof y&&1&e.s}b.targets=["template","associations","fields","newFields"],e.AbymeController=b});
//# sourceMappingURL=abyme.umd.js.map
